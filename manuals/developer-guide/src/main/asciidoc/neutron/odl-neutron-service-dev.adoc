== Neutron Service Developer Guide

=== Overview
This karaf feature provides integration support for OpenStack Neutron
via the ODL ML2 mechanism driver. Neutron Service is only one of the
components necessary for openstack integration.
It defines yang models for openstack neutron data models and northbound
API via REST API and yang model RESTCONF.

Those developers who wants to add new provider for new openstack neutron
extensions/services(Neutron constantly adds new extensions/services and ODL
will keep up with those new things.) need to communicate with this Neutron
Service or to add models to Neutron Service.
If you want to add new extensions/services themselves to Neutron Service,
new Yang data models need to be added. But it's out of scope of this document
because this guide is a developer who will be _using_ the feature
to build something separate, but _not_ somebody who will be developing
code for this feature itself.

=== Neutron Service Architecture
image::neutron/odl-neutron-service-developer-architecture.png[height="450px", width="550px", title="Neutron Service Architecture"]
// image original: https://docs.google.com/drawings/d/15xtroJahSFt93K10Zp8AVln_WZgowmhv7MC_2VdZQzg/edit?usp=sharing

Neutron Service defines YANG-models for openstack Neutron integration.
When openstack admins/users requests changes(creation/update/deletion)
of neutron resources (e.g. Neutron network, Neutron subnet, Neutron port
etc...), the corresponding yang model within ODL will be modified.
The ODL OpenStack will subscribe the changes on those models and
will be notified those modification through MD-SAL when changes are made.
Then provide will do actual necessary tasks to realize OpenStack Integration.
How to realize it (or even not realize it) is up to each providers.
Neutron Service doesn't care of it.

=== How to Write a SB Neutron Consumer
In Boron, there is only one options for SB Neutron Consumers:

* Listening for changes via the Neutron YANG model

Until Beryllium there was another way with the legacy I*Aware interface.
From Boron, the interface was eliminated. So all the SB Neutron Consumers
have to use Neutron YANG model.


=== Neutron Yang models
Neutron service defines Yang models for Neutron. The details can be found
at

* https://git.opendaylight.org/gerrit/gitweb?p=neutron.git;a=tree;f=model/src/main/yang;hb=HEAD

Basically those models are based on OpenStack Neutron API definitions.
For exact definitions, openstack neutron source code needs to be refered
as the above documentation doesn't always cover the necessary details.
There is nothing special to utilize those Neutron yang models.
The basic procedure will be

. Subscribe the model
. response on the data change notification on each models.

[NOTE]
Currently there is no way to refuse the request configuration at this
point. It's future work.

[source,java]
----
public class NeutronNetworkChangeListener implements DataChangeListener, AutoCloseable {
    private ListenerRegistration<DataChangeListener> registration;
    private DataBroker db;

    public NeutronNetworkChangeListener(DataBroker db){
        this.db = db;
        // create identity path to register on service startup
        InstanceIdentifier<Network> path = InstanceIdentifier
                .create(Neutron.class)
                .child(Networks.class)
                .child(Network.class);
        LOG.debug("Register listener for Neutron Network model data changes");
        // register for Data Change Notification
        registration =
                this.db.registerDataChangeListener(LogicalDatastoreType.CONFIGURATION, path, this, DataChangeScope.ONE);

    }

    @Override
    public void onDataChanged(
            AsyncDataChangeEvent<InstanceIdentifier<?>, DataObject> changes) {
        LOG.trace("Data changes : {}",changes);

        // handle data change notification
        Object[] subscribers = NeutronIAwareUtil.getInstances(INeutronNetworkAware.class, this);
        createNetwork(changes, subscribers);
        updateNetwork(changes, subscribers);
        deleteNetwork(changes, subscribers);
    }
----

=== Neutron configuration
From Boron, new models of configuration for OpenDaylight to tell
openstack neutron/networking-odl its configuration/capability.

==== hostconfig
This is for ODL to tell per-node configuration to neutron.
Especially this is used by pseudo agent port binding heavily.

The model definition can be found at

* https://git.opendaylight.org/gerrit/gitweb?p=neutron.git;a=blob;f=model/src/main/yang/neutron-hostconfig.yang;hb=HEAD

How to populate this for pseudo agent port binding is documented at

* http://git.openstack.org/cgit/openstack/networking-odl/tree/doc/source/devref/hostconfig.rst

==== neutron extension config
In Boron this is experimental.
The model definition can be found at

* https://git.opendaylight.org/gerrit/gitweb?p=neutron.git;a=blob;f=model/src/main/yang/neutron-extensions.yang;hb=HEAD

Each Neutron service providers have its own feature set. Some supports
full features of openstack, some supports only subsets.
With same supported neutron API, some functionality may or may not be
supported. So there is a need for a way that ODL can tell networking-odl its
capability. Thus networking-odl can initialize neutron properly based
on reported capability.


=== Neutorn Logger
There is another small service neturon-logger which logs changes of Neutron
Yang models. which can be used for debug/audit.

It would also help to understand how to listen the change.

* https://git.opendaylight.org/gerrit/gitweb?p=neutron.git;a=blob;f=neutron-logger/src/main/java/org/opendaylight/neutron/logger/NeutronLogger.java;hb=HEAD


=== API Reference Documentation
The OpenStack Neutron API references

* http://developer.openstack.org/api-ref-networking-v2.html
* http://developer.openstack.org/api-ref-networking-v2-ext.html
