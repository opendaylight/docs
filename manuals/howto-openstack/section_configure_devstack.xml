<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE section [
 <!-- Some useful entities borrowed from HTML -->
<!ENTITY ndash  "&#x2013;">
<!ENTITY mdash  "&#x2014;">
<!ENTITY hellip "&#x2026;">
]>
<section xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude"
    xmlns:xlink="http://www.w3.org/1999/xlink" version="5.0" xml:id="configure_devstack">
    <title>Configure the DevStack for the Openstack Controller</title>
    <para>Make sure all bridges are removed only if you have previously “stacked”</para>
    <para>
        <screen><command>$sudo ovs-vsctl show</command></screen>
    </para>
    <para>Once the OpenDaylight Controller is running, stack the OpenStack Controller:</para>
    <para><emphasis role="bold">Fedora 19:</emphasis></para>
    <para>
        <screen><command>
$ cd ~/
$ cd devstack
$ cp local.conf.control local.conf
$ vi local.conf</command></screen>
    </para>
    <para><emphasis role="bold">Fedora 20:</emphasis></para>
    <para>
        <screen><command>
$ cd ~/
$ cp local.conf.control devstack/local.conf
$ cd devstack
$ vi local.conf</command></screen>
    </para>
    <para>Edit the local.conf you just copied with the appropriate IPs. Replace all instances with
        brackets to the Daylight SDN controller, the OpenStack controller IP or the Openstack
        compute IP (Compute ethX address is only on the compute node).</para>
    <para>In the local.conf you will see four lines that require the hardcoding of an IP
        address.</para>
    <para>
        <screen><command>
SERVICE_HOST=
HOST_IP=
VNCSERVER_PROXYCLIENT_ADDRESS=
url=http://:8080/controller/nb/v2/neutron</command></screen>
    </para>
    <para>The following is the OpenStack controller local.conf for this tutorial:</para>
    <para>
        <screen><command>
[[local|localrc]]
LOGFILE=stack.sh.log
# Logging Section
SCREEN_LOGDIR=/opt/stack/data/log
LOG_COLOR=False
# Prevent refreshing of dependencies and DevStack recloning
OFFLINE=True
#RECLONE=yes

disable_service rabbit
enable_service qpid
enable_service n-cpu
enable_service n-cond
disable_service n-net
enable_service q-svc
enable_service q-dhcp
enable_service q-l3
enable_service q-meta
enable_service quantum
enable_service tempest

Q_HOST=$SERVICE_HOST
HOST_IP=172.16.86.129

Q_PLUGIN=ml2
Q_ML2_PLUGIN_MECHANISM_DRIVERS=opendaylight,logger
ENABLE_TENANT_TUNNELS=True
NEUTRON_REPO=https://github.com/CiscoSystems/neutron.git
NEUTRON_BRANCH=odl_ml2

VNCSERVER_PROXYCLIENT_ADDRESS=172.16.86.129
VNCSERVER_LISTEN=0.0.0.0

HOST_NAME=fedora-odl-1
SERVICE_HOST_NAME=${HOST_NAME}
SERVICE_HOST=172.16.86.129

FLOATING_RANGE=192.168.210.0/24
PUBLIC_NETWORK_GATEWAY=192.168.75.254
MYSQL_HOST=$SERVICE_HOST
RABBIT_HOST=$SERVICE_HOST
GLANCE_HOSTPORT=$SERVICE_HOST:9292
KEYSTONE_AUTH_HOST=$SERVICE_HOST
KEYSTONE_SERVICE_HOST=$SERVICE_HOST

MYSQL_PASSWORD=mysql
RABBIT_PASSWORD=rabbit
QPID_PASSWORD=rabbit
SERVICE_TOKEN=service
SERVICE_PASSWORD=admin
ADMIN_PASSWORD=admin

[[post-config|/etc/neutron/plugins/ml2/ml2_conf.ini]]
[agent]
minimize_polling=True

[ml2_odl]
url=http://172.16.86.129:8080/controller/nb/v2/neutron
username=admin
password=admin</command></screen>
    </para>
    <para>Verify the local.conf by greping for the IP prefix used:</para>
    <para>
        <screen><command>
$ grep 172.16 local.conf
HOST_IP=172.16.86.129
VNCSERVER_PROXYCLIENT_ADDRESS=172.16.86.129
SERVICE_HOST=172.16.86.129
url=http://172.16.86.129:8080/controller/nb/v2/neutron</command></screen>
    </para>
    <para>Finally execute the stack.sh shell script:</para>
    <para>
        <screen><command>$ ./stack.sh</command></screen>
    </para>
    <para>You should see activity in your OSGI console as Neutron adds the default private and
        public networks like so:</para>
    <para>
        <screen><computeroutput>
osgi&amp;gt; 2014-02-06 20:58:27.418 UTC [http-bio-8080-exec-1] INFO o.o.c.u.internal.UserManager - Local Authentication Succeeded for User: "admin"
2014-02-06 20:58:27.419 UTC [http-bio-8080-exec-1] INFO o.o.c.u.internal.UserManager - User "admin" authorized for the following role(s): [Network-Admin]</computeroutput></screen>
    </para>
    <para>You will see more activity as ODL programs the OVSDB server running on the OpenStack
        node.</para>
    <para>Here is the state of Open vSwitch after the stack completes and prior to booting a VM
        instance. If you do not see the is_connected: true boolean after Manager (OVSDB) and
        Controller (OpenFlow), an error has occured, check that the controller/manager IPs are
        reachable and the ports are bound using the lsof command listed earlier:</para>
    <screen><prompt>[odl@fedora-odl-1 devstack]$</prompt><command>sudo ovs-vsctl show</command>
<computeroutput>
17074e89-2ac5-4bba-997a-1a5a3527cf56
Manager "tcp:172.16.86.129:6640"
is_connected: true
Bridge br-int
Controller "tcp:172.16.86.129:6633"
is_connected: true
fail_mode: secure
Port br-int
Interface br-int
type: internal
Port "tap1e3dfa54-9c"
Interface "tap1e3dfa54-9c"
Bridge br-ex
Controller "tcp:172.16.86.129:6633"
is_connected: true
Port "tap9301c38d-d8"
Interface "tap9301c38d-d8"
Port br-ex
Interface br-ex
type: internal
ovs_version: "2.0.0"

Here are the OpenFlow v1.3 flow rules for the default namespace ports in OVS (qdhcp / qrouter):

[crayon-5326f94b7c170907686501 lang="bash" ]OFPST_FLOW reply (OF1.3) (xid=0x2):
cookie=0x0, duration=202.138s, table=0, n_packets=0, n_bytes=0, send_flow_rem in_port=1,dl_src=fa:16:3e:fb:4a:32 actions=set_field:0x2-&amp;gt;tun_id,goto_table:10
cookie=0x0, duration=202.26s, table=0, n_packets=0, n_bytes=0, send_flow_rem in_port=1,dl_src=fa:16:3e:2e:29:d3 actions=set_field:0x1-&amp;gt;tun_id,goto_table:10
cookie=0x0, duration=202.246s, table=0, n_packets=0, n_bytes=0, send_flow_rem priority=8192,in_port=1 actions=drop
cookie=0x0, duration=202.302s, table=0, n_packets=0, n_bytes=0, send_flow_rem dl_type=0x88cc actions=CONTROLLER:56
cookie=0x0, duration=202.186s, table=10, n_packets=0, n_bytes=0, send_flow_rem priority=8192,tun_id=0x1 actions=goto_table:20
cookie=0x0, duration=202.063s, table=10, n_packets=0, n_bytes=0, send_flow_rem priority=8192,tun_id=0x2 actions=goto_table:20
cookie=0x0, duration=202.14s, table=20, n_packets=0, n_bytes=0, send_flow_rem priority=8192,tun_id=0x1 actions=drop
cookie=0x0, duration=202.046s, table=20, n_packets=0, n_bytes=0, send_flow_rem priority=8192,tun_id=0x2 actions=drop
cookie=0x0, duration=202.2s, table=20, n_packets=0, n_bytes=0, send_flow_rem priority=16384,tun_id=0x1,dl_dst=01:00:00:00:00:00/01:00:00:00:00:00 actions=output:1
cookie=0x0, duration=202.083s, table=20, n_packets=0, n_bytes=0, send_flow_rem priority=16384,tun_id=0x2,dl_dst=01:00:00:00:00:00/01:00:00:00:00:00 actions=output:1
cookie=0x0, duration=202.211s, table=20, n_packets=0, n_bytes=0, send_flow_rem tun_id=0x1,dl_dst=fa:16:3e:2e:29:d3 actions=output:1
cookie=0x0, duration=202.105s, table=20, n_packets=0, n_bytes=0, send_flow_rem tun_id=0x2,dl_dst=fa:16:3e:fb:4a:32 actions=output:1</computeroutput></screen>
  </section>
