==   How to set up OpenStack for the integration with VTN Manager
This guide describes how to set up OpenStack for integration with OpenDaylight Controller.

While OpenDaylight Controller provides several ways to integrate with OpenStack, this guide focus on the way which uses VTN features available on OpenDaylight controller.
In the integration, VTN Manager work as network service provider for OpenStack.
VTN Manager features, enable OpenStack to work in pure OpenFlow environment in which all switches in data plane are OpenFlow switch.
=== Requirements
To use OpenDaylight Controller (ODL) as Network Service Provider for Openstack.
(By using VTN Neutron – OVSDB Integration).

====Components
.OpenDaylight Controller.
.OpenStack Control Node.
.OpenStack Compute Node.
.OpenFlow Switch like mininet(Not Mandatory).

 The VTN features support multiple OpenStack nodes. You can deploy multiple OpenStack Compute Nodes.
 In management plane, OpenDaylight Controller, OpenStack nodes and OpenFlow switches should communicate with each other.
 In data plane, Open vSwitches running in OpenStack nodes should communicate with each other through a physical or logical OpenFlow switches. The core OpenFlow switches are not mandatory. Therefore, you can directly connect to the Open vSwitch's.

=== Sample Configuration
reboot both nodes after the user and network settings to have the network settings applied to the network.
Login again and check the output of ifconfig to ensure that both interfaces are listed.

=== ODL Settings and Execution
===== vtn.ini
 * VTN uses the configuration parameters from  '''vtn.ini''' file for the OpenStack integration.
 * These values will be set for the OpenvSwitch, in all the participating OpenStack nodes.
 * A configuration file '''vtn.ini'''' needs to be created manually in the '''configuration''' directory.
 * The contents of '''vtn.ini''' should be as follows:
[cols=*4,1a,^,options="header",width="75%"]
|===
bridgename=br-int
portname=eth1
protocols=OpenFlow13
failmode=secure
==|
 * The values of the configuration parameters must be changed based on the user environment.
 * Especially, '''portname''' should be carefully configured, because if the value is wrong, OpenDaylight controller fails to forward packets.
 * Other parameters works fine as is for general use cases.
 * bridgename
   * The name of the bridge in Open vSwitch, that will be created by OpenDaylight Controller.
   * It must be "br-int".
 *portname
   * The name of the port that will be created in the vbridge in Open vSwitch.
   * This must be the same name of the interface of OpenStack Nodes which is used for interconnecting OpenStack Nodes in data plane.(in our case:eth1)
   * By default, if vtn.ini is not created, VTN uses ens33 as portname.
   * protocols
    * OpenFlow protocol through which OpenFlow Switch and Controller communicate.
    * The values can be OpenFlow13 or OpenFlow10.
  * failmode
    * The value can be "standalone" or "secure".
    * Please use '''"secure"''' for general use cases.

======= Start ODL Controller
   Please refer to the [[Release/Helium/VTN/Installation Guide|Installation Pages]] to run ODL with VTN Feature enabled.
   After running ODL Controller, please ensure ODL Controller listens to the ports:6633,6653, 6640 and 8080
   Please allow the ports in firewall for the devstack to be able to communicate with ODL Controller.
   Note
    6633/6653 - OpenFlow Ports
    6640 - OVS Manager Port
    8080 - Port for REST API

===== Devstack Setup
====== Get Devstack (All nodes)
  1. Install git application using
   sudo apt-get install git
  2. get devstack
   git clone https://git.openstack.org/openstack-dev/devstack;
  3. Switch to stable/Juno Version branch
   cd devstack
   git checkout stable/juno

====== Stack Control Node
.local.conf:
  cd devstack in the controller node
* Copy the contents of local.conf (devstack control node) from [[OpenDaylight Virtual Tenant Network (VTN):Scripts:devstack]] and save it as '''local.conf''' in the '''devstack'''.
* Please modify the IP Address values as required.
* Stack the node
  ./stack.sh

====== Verify Control Node stacking ======
*stack.sh prints out Horizon is now available at http://<CONTROL_NODE_IP_ADDRESS>:8080/
*Execute the command '''sudo ovs-vsctl show''' in the control node terminal and verify if the bridge '''br-int'''  is created.
* Typical output of the ovs-vsctl show is indicated below
    e232bbd5-096b-48a3-a28d-ce4a492d4b4f
    Manager "tcp:192.168.64.73:6640"
        is_connected: true
    Bridge br-int
        Controller "tcp:192.168.64.73:6633"
            is_connected: true
        fail_mode: secure
        Port "eth1"
           Interface "eth1"
    ovs_version: "2.0.2"

====== Stack Compute Node
*local.conf:
* cd devstack in the controller node
* Copy the contents of local.conf (devstack compute node) from [[OpenDaylight Virtual Tenant Network (VTN):Scripts:devstack]] and save it as local.conf in the '''devstack'''.
* Please modify the IP Address values as required.
* Stack the node
  ./stack.sh

====== Verify Compute Node stacking ======
*stack.sh prints out This is your host ip: <COMPUTE_NODE_IP_ADDRESS>
*Execute the command '''sudo ovs-vsctl show''' in the control node terminal and verify if the bridge '''br-int'''  is created.
* The output of the ovs-vsctl show will be similar to the one seen in control node.

===== Additional Verifications
* Please visit the ODL DLUX GUI after stacking all the nodes, http://<ODL_IP_ADDRESS>:8181/dlux/index.html. The switches, topology and the ports that are currently read can be validated.

======= Some Tips
* If the interconnected between the OVS is not seen, Please bring up the interface for the dataplane manually using the below comamnd
   ifup <interface_name>
* Some versions of OVS, drop packets when there is a table-miss, So please add the below flow to all the nodes with OVS version (>=2.1)
  ovs-ofctl --protocols=OpenFlow13 add-flow br-int priority=0,actions=output:CONTROLLER
* Please Accept Promiscuous mode in the networks involving the interconnect.

===Create VM from Devstack Horizon GUI
.Login to http://<CONTROL_NODE_IP>:8080/ to check the horizon GUI.
  image::OpenStackGui.png
 Enter the value for User Name as admin and enter the value for Password as labstack.
. We should first ensure both the hypervisors(control node and compute node) are mapped under hypervisors by clicking on Hpervisors tab.image:https://wiki.opendaylight.org/view/File:Hypervisors.png[
  "HyperVisors",width=128,link="https://wiki.opendaylight.org/view/File:Hypervisors.png"]
.Create a new Network from Horizon GUI.
* Click on Networks Tab.
* click on the Create Network button.
image::Create_Network.png
* A popup screen will appear.
* Enter network name and click Next button.
 image::Creare_Network_Step_1.png
* Create a sub network by giving Network Address and click Next button .
 image::Create_Network_Step_2
* Specify the additional details for subnetwork (please refer the image for your reference).
image::Create_Network_Step_3
* Click Create button .
.Create VM Instance
*Navigate to Instances tab in the GUI.
image:: Instance_ping
* Click on Lauch Instances button.
image::Launch_Instance.png
* Click on Details tab to enter the VM details.For this demo we are creating Ten VM's(insances).
 image::Launch_Instance.png
*In the Networking tab, we must select the network,for this we need to drag and drop the Available networks to Selected Networks (i.e) Drag vtn1 we created  from Available networks to Selected Networks and click Launch to create the instances.
 image::Launch_Instance_network.png
* Ten VM's will be created.
  image::Load_All_Instances.png
*Click on any VM displayed in the Instances tab and click the Console tab.
  image::Instance_Console.png"]
* Login to the VM console and verify with a ping commad.
  image::Instance_ping.png

=== Verification of Control and Compute Node after VM creation
The output of sudo ovs-vsctl command after VM creation
[cols=*3,2a,^,options="header",width="75%"]
|===
|
  [stack@icehouse-compute-odl devstack]$ sudo ovs-vsctl show  Manager "tcp:192.168.64.73:6640"
  is_connected: true
  Bridge br-int
  Controller "tcp:192.168.64.73:6633"
  is_connected: true
  fail_mode: secure
  Port "tapa2e1ef67-79"
  Interface "tapa2e1ef67-79"
  Port "tap5f34d39d-5e"
  Interface "tap5f34d39d-5e"
  Port "tapc2858395-f9"
  Interface "tapc2858395-f9"
  Port "tapa9ea900a-4b"
  Interface "tapa9ea900a-4b"
  Port "tapc63ef3de-53"
  Interface "tapc63ef3de-53"
  Port "tap01d51478-8b"
  Interface "tap01d51478-8b"
  Port "tapa0b085ab-ce"
  Interface "tapa0b085ab-ce"
   Port "tapeab380de-8f"
  Interface "tapeab380de-8f"
  Port "tape404538c-0a"
  Interface "tape404538c-0a"
  Port "tap2940658d-15"
  Interface "tap2940658d-15"
  Port "ens224"
  Interface "ens224"
  ovs_version: "2.3.0"
  <code>[stack@icehouse-controller-odl devstack]$ sudo ovs-vsctl show
  Manager "tcp:192.168.64.73:6640"
  is_connected: true
  Bridge br-int
  Controller "tcp:192.168.64.73:6633"
  is_connected: true
  fail_mode: secure
  Port "tap71790d18-65"
  Interface "tap71790d18-65"
  Port "ens224"
  Interface "ens224"
  ovs_version: "2.3.0"
Note:In the above scenario more nodes have been created in the compute node
|===
== References
http://devstack.org/guides/multinode-lab.html
http://www.siliconloons.com/opendaylight-integration-with-openstack-has-merged-into-icehouse/

http://networkstatic.net/opendaylight-openstack-integration-devstack-fedora-20/
https://wiki.opendaylight.org/view/File:Vtn_demo_hackfest_2014_march.pdf
http://networkstatic.net/opendaylight-openstack-integration-devstack-fedora-20/